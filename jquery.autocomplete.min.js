(function(c){c.fn.extend({autocomplete:function(a,b){var n="string"==typeof a,b=c.extend({},c.Autocompleter.defaults,{url:n?a:null,data:n?null:a,delay:n?c.Autocompleter.defaults.delay:10,max:b&&!b.scroll?10:150},b);b.highlight=b.highlight||function(a){return a};b.formatMatch=b.formatMatch||b.formatItem;return this.each(function(){new c.Autocompleter(this,b)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")},launchManual:function(){return this.trigger("launchManual")},refresh:function(){return this.trigger("refresh")}});c.Autocompleter=function(a,b){var n,p;function o(){var t=j.selected();if(!t)return!1;var g=t.result;q=g;if(b.multiple){var d=m(f.val());if(1<d.length){var i=b.multipleSeparator.length,e=c(a).selection().start,h,k=0;c.each(d,function(a,b){k+=b.length;if(e<=k)return h=
a,!1;k+=i});d[h]=g;g=d.join(b.multipleSeparator)}g+=b.multipleSeparator}f.val(g);s();f.trigger("result",[t.data,t.value]);b.afterItemSelected&&b.afterItemSelected(t,f);return!0}function l(a,g){if(u==n)j.hide();else{var c=f.val();if(g||c!=q)q=c,c=i(c),c.length>=b.minChars?(f.addClass(b.loadingClass),b.matchCase||(c=c.toLowerCase()),e(c,d,s)):(f.removeClass(b.loadingClass),j.hide())}}function m(a){return!a?[""]:!b.multiple?[c.trim(a)]:c.map(a.split(b.multipleSeparator),function(b){return c.trim(a).length?
c.trim(b):null})}function i(g){if(!b.multiple)return g;var d=m(g);if(1==d.length)return d[0];d=c(a).selection().start;d=d==g.length?m(g):m(g.replace(g.substring(d),""));return d[d.length-1]}function s(){j.visible();j.hide();clearTimeout(r);f.removeClass(b.loadingClass);b.mustMatch&&f.search(function(a){a||(b.multiple?(a=m(f.val()).slice(0,-1),f.val(a.join(b.multipleSeparator)+(a.length?b.multipleSeparator:""))):(f.val(""),f.trigger("result",null)))})}function d(d,e){if(e&&e.length&&g){f.removeClass(b.loadingClass);
j.display(e,d);var h=e[0].value;b.autoFill&&i(f.val()).toLowerCase()==d.toLowerCase()&&u!=p&&(f.val(f.val()+h.substring(i(q).length)),c(a).selection(q.length,q.length+h.length));j.show()}else s()}function e(g,d,f){b.matchCase||(g=g.toLowerCase());var e=h.load(g);if(e&&e.length)d(g,e);else if("string"==typeof b.url&&0<b.url.length){var m={timestamp:+new Date};c.each(b.extraParams,function(a,b){m[a]="function"==typeof b?b():b});c.ajax({mode:"abort",port:"autocomplete"+a.name,dataType:b.dataType,url:b.url,
data:c.extend({q:i(g),limit:b.max},m),success:function(a){var f;if(!(f=b.parse&&b.parse(a))){f=[];for(var a=a.split("\n"),e=0;e<a.length;e++){var i=c.trim(a[e]);i&&(i=i.split("|"),f[f.length]={data:i,value:i[0],result:b.formatResult&&b.formatResult(i,i[0])||i[0]})}}h.add(g,f);d(g,f)}})}else j.emptyList(),null!=k?k():f(g)}n=46;p=8;var k=null;if(null!=b.failure&&"function"==typeof b.failure)k=b.failure;var f=c(a).attr("autocomplete","off").addClass(b.inputClass),r,q="",h=c.Autocompleter.Cache(b),g=
0,u,w={mouseDownOnSelect:!1},j=c.Autocompleter.Select(b,a,o,w),v;c.browser.opera&&c(a.form).bind("submit.autocomplete",function(){if(v)return v=!1});f.bind((c.browser.opera?"keypress":"keydown")+".autocomplete",function(a){g=1;u=a.keyCode;switch(a.keyCode){case 38:j.visible()?(a.preventDefault(),j.prev()):l(0,!0);break;case 40:j.visible()?(a.preventDefault(),j.next()):l(0,!0);break;case 33:j.visible()?(a.preventDefault(),j.pageUp()):l(0,!0);break;case 34:j.visible()?(a.preventDefault(),j.pageDown()):
l(0,!0);break;case b.multiple&&","==c.trim(b.multipleSeparator)&&188:case 9:case 13:if(o())return a.preventDefault(),v=!0,!1;break;case 27:j.hide();break;default:clearTimeout(r),r=setTimeout(l,b.delay)}}).focus(function(){g++}).blur(function(){g=0;w.mouseDownOnSelect||(clearTimeout(r),r=setTimeout(s,200))}).click(function(){b.clickFire?j.visible()||l(0,!0):1<g++&&!j.visible()&&l(0,!0)}).bind("search",function(){function a(g,d){var c;if(d&&d.length)for(var e=0;e<d.length;e++)if(d[e].result.toLowerCase()==
g.toLowerCase()){c=d[e];break}"function"==typeof b?b(c):f.trigger("result",c&&[c.data,c.value])}var b=1<arguments.length?arguments[1]:null;c.each(m(f.val()),function(b,g){e(g,a,a)})}).bind("flushCache",function(){h.flush()}).bind("setOptions",function(a,g){c.extend(!0,b,g);"data"in g&&h.populate()}).bind("unautocomplete",function(){j.unbind();f.unbind();c(a.form).unbind(".autocomplete")}).bind("launchManual",function(){s();f.focus();h.load(f.val())||(h.flush(),h.populate());u=40;l(0,!0)}).bind("refresh",
function(){f.flushCache();f.launchManual()})};c.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:100,max:1E3,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:" ",inputFocus:!0,clickFire:!1,highlight:function(a,b){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,
"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180,scrollJumpPosition:!0};c.Autocompleter.Cache=function(a){function b(b,c){a.matchCase||(b=b.toLowerCase());var d=b.indexOf(c);"word"==a.matchContains&&(d=b.toLowerCase().search("\\b"+c.toLowerCase()));return-1==d?!1:0==d||a.matchContains}function n(b,c){m>a.cacheLength&&o();l[b]||m++;l[b]=c}function p(){if(!a.data)return!1;var b={},m=0;if(!a.url)a.cacheLength=1;b[""]=[];for(var d=0,e=a.data.length;d<e;d++){var k=
a.data[d],k="string"==typeof k?[k]:k,f=a.formatMatch(k,d+1,a.data.length);if(!1!==f){var l=f.charAt(0).toLowerCase();b[l]||(b[l]=[]);k={value:f,data:k,result:a.formatResult&&a.formatResult(k)||f};b[l].push(k);m++<a.max&&b[""].push(k)}}c.each(b,function(b,c){a.cacheLength++;n(b,c)})}function o(){l={};m=0}var l={},m=0;setTimeout(p,25);return{flush:o,add:n,populate:p,load:function(i){if(!a.cacheLength||!m)return null;if(!a.url&&a.matchContains){var n=[],d;for(d in l)if(0<d.length){var e=l[d];c.each(e,
function(a,c){b(c.value,i)&&n.push(c)})}return n}if(l[i])return l[i];if(a.matchSubset)for(d=i.length-1;d>=a.minChars;d--)if(e=l[i.substr(0,d)])return n=[],c.each(e,function(a,c){b(c.value,i)&&(n[n.length]=c)}),n;return null}}};c.Autocompleter.Select=function(a,b,n,p){var o;function l(){r&&(q=c("<div/>").hide().addClass(a.resultsClass).css("position","absolute").appendTo(document.body).hover(function(){c(this).is(":visible")&&b.focus();p.mouseDownOnSelect=!1}),h=c("<ul/>").appendTo(q).mouseover(function(a){m(a).nodeName&&
"LI"==m(a).nodeName.toUpperCase()&&(e=c("li",h).removeClass(o).index(m(a)),c(m(a)).addClass(o))}).click(function(g){c(m(g)).addClass(o);n();a.inputFocus&&b.focus();return!1}).mousedown(function(){p.mouseDownOnSelect=!0}).mouseup(function(){p.mouseDownOnSelect=!1}),0<a.width&&q.css("width",a.width),r=!1)}function m(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function i(b){d.slice(e,e+1).removeClass(o);s(b);b=d.slice(e,e+1).addClass(o);if(a.scroll){var c=0;d.slice(0,e).each(function(){c+=
this.offsetHeight});c+b[0].offsetHeight-h.scrollTop()>h[0].clientHeight?h.scrollTop(c+b[0].offsetHeight-h.innerHeight()):c<h.scrollTop()&&h.scrollTop(c)}}function s(b){if(a.scrollJumpPosition||!a.scrollJumpPosition&&!(0>b&&0==e||0<b&&e==d.size()-1))e+=b,0>e?e=d.size()-1:e>=d.size()&&(e=0)}o="ac_over";var d,e=-1,k,f="",r=!0,q,h;return{display:function(b,i){l();k=b;f=i;h.empty();for(var m=a.max&&a.max<k.length?a.max:k.length,j=0;j<m;j++)if(k[j]){var n=a.formatItem(k[j].data,j+1,m,k[j].value,f);!1!==
n&&(n=c("<li/>").html(a.highlight(n,f)).addClass(0==j%2?"ac_even":"ac_odd").appendTo(h)[0],c.data(n,"ac_data",k[j]))}d=h.find("li");a.selectFirst&&(d.slice(0,1).addClass(o),e=0);c.fn.bgiframe&&h.bgiframe()},next:function(){i(1)},prev:function(){i(-1)},pageUp:function(){0!=e&&0>e-8?i(-e):i(-8)},pageDown:function(){e!=d.size()-1&&e+8>d.size()?i(d.size()-1-e):i(8)},hide:function(){q&&q.hide();d&&d.removeClass(o);e=-1},visible:function(){return q&&q.is(":visible")},current:function(){return this.visible()&&
(d.filter("."+o)[0]||a.selectFirst&&d[0])},show:function(){var e=c(b).offset();q.css({width:"string"==typeof a.width||0<a.width?a.width:c(b).width(),top:e.top+b.offsetHeight,left:e.left}).show();if(a.scroll&&(h.scrollTop(0),h.css({maxHeight:a.scrollHeight,overflow:"auto"}),c.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var f=0;d.each(function(){f+=this.offsetHeight});e=f>a.scrollHeight;h.css("height",e?a.scrollHeight:f);e||d.width(h.width()-parseInt(d.css("padding-left"))-parseInt(d.css("padding-right")))}},
selected:function(){var a=d&&d.filter("."+o).removeClass(o);return a&&a.length&&c.data(a[0],"ac_data")},emptyList:function(){h&&h.empty()},unbind:function(){q&&q.remove()}}};c.fn.selection=function(a,b){if(void 0!==a)return this.each(function(){if(this.createTextRange){var c=this.createTextRange();void 0===b||a==b?c.move("character",a):(c.collapse(!0),c.moveStart("character",a),c.moveEnd("character",b));c.select()}else if(this.setSelectionRange)this.setSelectionRange(a,b);else if(this.selectionStart)this.selectionStart=
a,this.selectionEnd=b});var c=this[0];if(c.createTextRange){var p=document.selection.createRange(),o=c.value,l=p.text.length;p.text="<->";p=c.value.indexOf("<->");c.value=o;this.selection(p,p+l);return{start:p,end:p+l}}if(void 0!==c.selectionStart)return{start:c.selectionStart,end:c.selectionEnd}}})(jQuery);
